name: Auto Build & Fix

# Test workflow with new token

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: Install dependencies
        id: install
        run: |
          pnpm install --frozen-lockfile || {
            echo "âš ï¸ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨, ìºì‹œ í´ë¦¬ì–´ í›„ ìž¬ì‹œë„..."
            rm -rf node_modules apps/*/node_modules
            pnpm store prune || true
            pnpm install --frozen-lockfile
          }
      
      - name: Auto-fix errors
        id: auto-fix
        continue-on-error: true
        run: |
          echo "ðŸ”§ ìžë™ ìˆ˜ì • ì‹œìž‘..."
          
          # 1. ë¦°íŠ¸ ì—ëŸ¬ ìžë™ ìˆ˜ì •
          echo "ðŸ“ ë¦°íŠ¸ ì—ëŸ¬ ìˆ˜ì • ì¤‘..."
          pnpm lint --fix || true
          
          # 2. TypeScript íƒ€ìž… ì—ëŸ¬ í™•ì¸ ë° ëˆ„ë½ëœ íƒ€ìž… íŒ¨í‚¤ì§€ ì„¤ì¹˜
          echo "ðŸ” TypeScript ì—ëŸ¬ í™•ì¸ ì¤‘..."
          TS_ERRORS=$(pnpm exec tsc --noEmit 2>&1 || true)
          
          if echo "$TS_ERRORS" | grep -q "Cannot find module.*@types/"; then
            echo "ðŸ“¦ ëˆ„ë½ëœ íƒ€ìž… íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
            MISSING_TYPES=$(echo "$TS_ERRORS" | grep -oP "Cannot find module.*@types/\K\w+" | sort -u || true)
            if [ -n "$MISSING_TYPES" ]; then
              for type in $MISSING_TYPES; do
                echo "  â†’ @types/$type"
                pnpm add -D @types/$type || true
              done
            fi
          fi
          
          # 3. ë³€ê²½ì‚¬í•­ í™•ì¸
          if [ -n "$(git status --porcelain)" ]; then
            echo "fixed=true" >> $GITHUB_OUTPUT
            echo "âœ… ìžë™ ìˆ˜ì •ëœ íŒŒì¼ì´ ìžˆìŠµë‹ˆë‹¤"
          else
            echo "fixed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ìžë™ ìˆ˜ì •í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤"
          fi
      
      - name: Build with retry
        id: build
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "ðŸ—ï¸ ë¹Œë“œ ì‹œìž‘..."
            
            # ë©”ëª¨ë¦¬ ë¶€ì¡± ëŒ€ë¹„
            export NODE_OPTIONS="--max-old-space-size=4096"
            
            # ë¹Œë“œ ì‹¤í–‰
            pnpm build:all || {
              BUILD_LOG=$(pnpm build:all 2>&1 || true)
              
              # ë©”ëª¨ë¦¬ ë¶€ì¡± ì—ëŸ¬
              if echo "$BUILD_LOG" | grep -q "JavaScript heap out of memory"; then
                echo "ðŸ”§ ë©”ëª¨ë¦¬ ë¶€ì¡± ê°ì§€, ë©”ëª¨ë¦¬ ì¦ê°€ í›„ ìž¬ì‹œë„..."
                export NODE_OPTIONS="--max-old-space-size=6144"
                pnpm build:all
              else
                exit 1
              fi
            }
      
      - name: Commit auto-fixes
        if: steps.auto-fix.outputs.fixed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.BUKAE_CLIENT_BUILD_TOKEN }}
        run: |
          echo "ðŸ’¾ ìžë™ ìˆ˜ì •ëœ ë‚´ìš© ì»¤ë°‹ ì¤‘..."
          
          # ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ðŸ”§ Auto-fix: build errors [skip ci]" || {
              echo "âš ï¸ ì»¤ë°‹ ì‹¤íŒ¨ (ì´ë¯¸ ì»¤ë°‹ë˜ì—ˆê±°ë‚˜ ë³€ê²½ì‚¬í•­ ì—†ìŒ)"
              exit 0
            }
            
            # ê°™ì€ ë¸Œëžœì¹˜ì— í‘¸ì‹œ (í† í°ì„ URLì— ì§ì ‘ í¬í•¨)
            git remote set-url origin https://${{ secrets.BUKAE_CLIENT_BUILD_TOKEN }}@github.com/${{ github.repository }}.git
            git config --local credential.helper ""
            git push https://${{ secrets.BUKAE_CLIENT_BUILD_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }} || {
              echo "âš ï¸ í‘¸ì‹œ ì‹¤íŒ¨ (ê¶Œí•œ ë¬¸ì œ ë˜ëŠ” ì¶©ëŒ)"
              exit 0
            }
            
            echo "âœ… ìžë™ ìˆ˜ì •ëœ ë‚´ìš©ì´ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤"
          else
            echo "â„¹ï¸ ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          fi
      
      - name: Build summary
        if: always()
        run: |
          echo "## ðŸ“Š ë¹Œë“œ ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ ìƒíƒœ**: ${{ steps.build.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ìžë™ ìˆ˜ì •**: ${{ steps.auto-fix.outputs.fixed }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.auto-fix.outputs.fixed }}" == "true" ]; then
            echo "- **ì»¤ë°‹**: ìžë™ ìˆ˜ì •ëœ ë‚´ìš©ì´ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "âœ… ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          fi
