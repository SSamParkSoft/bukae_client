name: CI/CD

on:
  pull_request:
    types: [opened, synchronize, labeled]
  issue_comment:
    types: [created]
  check_run:
    types: [completed]

jobs:
  check-and-merge:
    runs-on: ubuntu-latest
    # develop ë˜ëŠ” main ë¸Œëœì¹˜ë¡œì˜ PRë§Œ ì²´í¬
    if: |
      (github.event.pull_request.base.ref == 'develop' || 
       github.event.pull_request.base.ref == 'main') &&
      github.event.pull_request.state == 'open'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for CodeRabbit check to complete
        id: wait_checks
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            
            if (!prNumber) {
              console.log('No PR number found');
              return false;
            }

            console.log(`Waiting for CodeRabbit check to complete for PR #${prNumber}...`);

            // ìµœëŒ€ 5ë¶„ ëŒ€ê¸° (30ì´ˆë§ˆë‹¤ ì²´í¬)
            const maxWaitTime = 5 * 60 * 1000; // 5ë¶„
            const checkInterval = 30 * 1000; // 30ì´ˆ
            const startTime = Date.now();

            while (Date.now() - startTime < maxWaitTime) {
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.payload.pull_request?.head?.sha || context.sha,
              });

              // CodeRabbit ì²´í¬ ì°¾ê¸°
              const codeRabbitCheck = checks.check_runs.find(
                check => check.name.includes('CodeRabbit') || check.name.includes('code-rabbit')
              );

              if (!codeRabbitCheck || codeRabbitCheck.status === 'completed') {
                console.log('CodeRabbit check completed');
                return true;
              }

              console.log(`Waiting... CodeRabbit status: ${codeRabbitCheck.status}`);
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }

            console.log('Timeout waiting for CodeRabbit check');
            return false;

      - name: Check for Critical/Major issues from CodeRabbit
        id: check_issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            
            if (!prNumber) {
              console.log('No PR number found');
              core.setOutput('has_issues', 'false');
              return;
            }

            console.log(`Checking PR #${prNumber} for Critical/Major issues from CodeRabbit...`);

            // PRì˜ ëª¨ë“  ì½”ë©˜íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            // CodeRabbit ë´‡ì˜ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const codeRabbitComments = comments.filter(
              comment => 
                comment.user.login.includes('coderabbit') || 
                comment.user.login === 'coderabbitai' ||
                (comment.user.type === 'Bot' && comment.user.login.includes('code'))
            );

            console.log(`Found ${codeRabbitComments.length} CodeRabbit comments`);

            let hasCriticalOrMajor = false;
            
            // Critical ë˜ëŠ” Major íŒ¨í„´ ì •ì˜
            const criticalPatterns = [
              /Potential issue \| Critical/i,
              /Potential issue \| Major/i,
              /ğŸ”´.*Critical/i,
              /Critical.*issue/i,
              /Major.*issue/i,
            ];

            // ê° ì½”ë©˜íŠ¸ ì²´í¬
            for (const comment of codeRabbitComments) {
              const body = comment.body || '';
              
              // ì‹¬ê°ë„ ë¼ë²¨ ì²´í¬
              if (criticalPatterns.some(pattern => pattern.test(body))) {
                hasCriticalOrMajor = true;
                console.log(`âŒ Critical or Major issue found in comment #${comment.id} by ${comment.user.login}`);
                console.log(`Preview: ${body.substring(0, 150)}...`);
                break;
              }
            }

            // PR ë¦¬ë·° ì½”ë©˜íŠ¸ë„ ì²´í¬
            try {
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });

              for (const review of reviews) {
                if (review.user.login.includes('coderabbit') || 
                    (review.user.type === 'Bot' && review.user.login.includes('code'))) {
                  const body = review.body || '';
                  if (criticalPatterns.some(pattern => pattern.test(body))) {
                    hasCriticalOrMajor = true;
                    console.log(`âŒ Critical or Major issue found in review #${review.id}`);
                    break;
                  }
                }
              }
            } catch (error) {
              console.log('Could not fetch reviews:', error.message);
            }

            // Status Check ê²°ê³¼ë„ í™•ì¸
            try {
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.payload.pull_request?.head?.sha || context.sha,
              });

              // CodeRabbit ì²´í¬ê°€ ì‹¤íŒ¨í–ˆëŠ”ì§€ í™•ì¸
              const codeRabbitCheck = checks.check_runs.find(
                check => check.name.includes('CodeRabbit') || check.name.includes('code-rabbit')
              );

              if (codeRabbitCheck && codeRabbitCheck.conclusion === 'failure') {
                hasCriticalOrMajor = true;
                console.log('âŒ CodeRabbit check failed');
              }
            } catch (error) {
              console.log('Could not fetch checks:', error.message);
            }

            // ê²°ê³¼ ì¶œë ¥
            core.setOutput('has_issues', hasCriticalOrMajor.toString());
            
            if (hasCriticalOrMajor) {
              console.log('ğŸš« PR has Critical or Major issues - merge blocked');
            } else {
              console.log('âœ… No Critical or Major issues found - merge allowed');
            }

      - name: Auto merge if no Critical/Major issues
        if: steps.check_issues.outputs.has_issues == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            
            if (!prNumber) {
              console.log('No PR number found, skipping merge');
              return;
            }

            // PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            // ì´ë¯¸ ë¨¸ì§€ë˜ì—ˆê±°ë‚˜ ë‹«í˜”ìœ¼ë©´ ìŠ¤í‚µ
            if (pr.state !== 'open' || pr.merged) {
              console.log(`PR #${prNumber} is not open or already merged`);
              return;
            }

            // ìë™ ë¨¸ì§€ ì‹¤í–‰ (rebase ë°©ì‹)
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'rebase',
                commit_title: `Merge PR #${prNumber}: ${pr.title}`,
              });
              
              console.log(`âœ… PR #${prNumber} merged automatically using rebase`);
            } catch (error) {
              // ë¨¸ì§€ ì‹¤íŒ¨ ì‹œ (ì˜ˆ: ì¶©ëŒ, ë¸Œëœì¹˜ ë³´í˜¸ ê·œì¹™ ë“±)
              console.log(`âš ï¸ Could not merge PR #${prNumber}:`, error.message);
              // ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬ (ìˆ˜ë™ ë¨¸ì§€ ê°€ëŠ¥)
            }

      - name: Comment if Critical/Major issues found
        if: steps.check_issues.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            
            if (!prNumber) {
              return;
            }

            // ì´ë¯¸ ì½”ë©˜íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
            const { data: existingComments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const hasExistingComment = existingComments.some(
              comment => 
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('ìë™ ë¨¸ì§€ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤')
            );

            if (!hasExistingComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'âš ï¸ **ìë™ ë¨¸ì§€ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤**\n\nCodeRabbitì´ **Critical** ë˜ëŠ” **Major** ì´ìŠˆë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.\n\nì´ìŠˆë¥¼ í•´ê²°í•˜ê±°ë‚˜ "Resolve conversation"ìœ¼ë¡œ í•´ê²° í‘œì‹œë¥¼ í•´ì£¼ì„¸ìš”.\ní•´ê²° í›„ PRì„ ì—…ë°ì´íŠ¸í•˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ì²´í¬ë©ë‹ˆë‹¤.',
              });
            }
