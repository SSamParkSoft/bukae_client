# 캔버스 상태 기반 내보내기 및 속도 최적화 PRD

## 목표
내보내기 시점에 모든 씬의 캔버스 실제 상태를 읽어서 최신 transform을 반영하고, 내보내기 속도를 2-3배 향상시킵니다.

## 작업 1: useVideoExport에 캔버스 refs 추가
- useVideoExport의 UseVideoExportParams 인터페이스에 spritesRef, textsRef 추가
- 타입: React.MutableRefObject<Map<number, PIXI.Sprite>>, React.MutableRefObject<Map<number, PIXI.Text>>
- 파일: apps/bukae_creator/hooks/video/useVideoExport.ts

## 작업 2: 모든 씬의 캔버스 상태 읽기 함수 구현
- getAllCanvasTransforms 함수 생성
- timeline.scenes를 순회하면서 각 씬의 spritesRef.current.get(sceneIndex)와 textsRef.current.get(sceneIndex)에서 실제 위치/크기/회전 읽기
- PixiJS 객체의 x, y, width, height, rotation, scale 속성 사용
- 텍스트의 경우 getBounds()로 실제 크기 계산
- Map<sceneIndex, { imageTransform?, textTransform? }> 형태로 반환
- Promise.all로 모든 씬의 상태를 동시에 읽기 (병렬 처리)
- 파일: apps/bukae_creator/hooks/video/useVideoExport.ts

## 작업 3: 내보내기 로직에서 캔버스 상태 사용
- handleExport 함수 시작 부분에서 getAllCanvasTransforms 호출
- 씬 그룹 생성 시 firstScene.imageTransform 대신 캔버스에서 읽은 이미지 transform 사용
- 씬 그룹 생성 시 lastScene.text.transform 대신 캔버스에서 읽은 텍스트 transform 사용
- 캔버스 상태가 없으면 timeline의 transform을 fallback으로 사용
- 파일: apps/bukae_creator/hooks/video/useVideoExport.ts

## 작업 4: 캐시 확인 병렬화
- 현재 순차 for 루프로 캐시 확인하는 부분을 Promise.all로 변경
- 모든 씬의 캐시 상태를 동시에 확인하여 속도 향상
- 파일: apps/bukae_creator/hooks/video/useVideoExport.ts

## 작업 5: TTS 합성 배치 크기 및 딜레이 최적화
- 배치 크기를 2 → 4로 증가
- 배치 딜레이를 동적 조정: 정상 시 0.5초, 레이트 리밋 발생 시 2초
- 마지막 배치에서 딜레이 제거
- 파일: apps/bukae_creator/hooks/video/useVideoExport.ts

## 작업 6: TTS 업로드 스트리밍
- 합성 완료 즉시 업로드 시작 (전체 합성 완료 대기 없이)
- 각 씬의 TTS 합성이 완료되면 즉시 업로드 프로세스 시작
- 파일: apps/bukae_creator/hooks/video/useVideoExport.ts

## 작업 7: useStep4Container에서 refs 전달
- useVideoExport 호출 시 spritesRef, textsRef 전달
- 파일: apps/bukae_creator/app/video/create/step4/hooks/useStep4Container.ts

## 작업 8: Playwright MCP 테스트
- 브라우저에서 step4 페이지 열기
- 여러 씬에 대해 캔버스에서 이미지/텍스트 드래그하여 위치 변경
- 씬 전환하여 각 씬의 상태 확인
- 내보내기 버튼 클릭
- 네트워크 요청 확인하여 전송된 JSON의 transform 값이 각 씬의 캔버스 상태와 일치하는지 검증
- 콘솔 로그로 디버깅 정보 확인
- 내보내기 소요 시간 측정

